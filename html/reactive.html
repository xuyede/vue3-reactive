<script>
  const targetMap = new WeakMap()
  let activeEffect = null

  function track(target, key) {
    if (activeEffect) {
      let depsMap = targetMap.get(target);
      if (!depsMap) {
        targetMap.set(target, ( depsMap = new Map() ))
      }
      let dep = depsMap.get(key)
      if (!dep) {
        depsMap.set(key, ( dep = new Set() ))
      }

      dep.add(activeEffect);
    }
  }

  function trigger(target, key) {
    let depsMap = targetMap.get(target);
    if (!depsMap) return
    let dep = depsMap.get(key)
    if (dep) {
      dep.forEach(effect => {
        effect()
      })
    }
  }

  function watchEffect(eff) {
    activeEffect = eff
    activeEffect()
    activeEffect = null
  }

  const proxyHandler = {
    get(target, key, receiver) {
      track(target, key)
      return Reflect.get(target, key, receiver)
    },
    set(target, key, value, receiver) {
      const oldValue = target[key];
      const result = Reflect.set(target, key, value, receiver)
      if (result && oldValue != value) {
        trigger(target, key)
      }
      return result
    }
  }

  function reactive(raw) {
    return new Proxy(raw, proxyHandler)
  }

  let state = reactive({
    count: 0
  })

  watchEffect(() => {
    console.log(state.count)
  }) // 0

  state.count++; // 1

</script>